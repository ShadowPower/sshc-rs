<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSH 连接管理器</title>
    <style>
        :root {
            --font-family: "Segoe UI Variable", "Segoe UI", "Microsoft YaHei UI", system-ui, -apple-system, sans-serif;
            --font-monospace: "Cascadia Mono", "Consolas", "Courier New", monospace;
            --control-corner-radius: 4px;
            --layer-corner-radius: 6px;
        }

        @media (prefers-color-scheme: light) {
            :root {
                --fill-color-layer-1: #f3f3f3;
                --fill-color-layer-2: #e8e8e8;
                --fill-color-layer-3: #ffffff;
                --fill-color-control: #ffffff;
                --fill-color-control-hover: #f9f9f9;
                --fill-color-control-disabled: #f3f3f3;
                --fill-color-accent: #0078d4;
                --fill-color-accent-hover: #106ebe;
                --fill-color-list-selected: #0078d4;
                --fill-color-list-hover: rgba(0, 0, 0, 0.05);
                --stroke-color-default: #d1d1d1;
                --stroke-color-control: #bababa;
                --stroke-color-focus: #005a9e;
                --text-primary: #0d0d0d;
                --text-secondary: #5c5c5c;
                --text-on-accent: #ffffff;
                --text-disabled: #8a8a8a;
                --text-danger: #d13438;
                --drop-target: rgba(0, 120, 212, 0.1);
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --fill-color-layer-1: #202020;
                --fill-color-layer-2: #2b2b2b;
                --fill-color-layer-3: #1e1e1e;
                --fill-color-control: #2d2d2d;
                --fill-color-control-hover: #383838;
                --fill-color-control-disabled: #252525;
                --fill-color-accent: #0095ff;
                --fill-color-accent-hover: #3aaeff;
                --fill-color-list-selected: #004a7c;
                --fill-color-list-hover: rgba(255, 255, 255, 0.08);
                --stroke-color-default: #383838;
                --stroke-color-control: #555555;
                --stroke-color-focus: #0095ff;
                --text-primary: #f2f2f2;
                --text-secondary: #a1a1a1;
                --text-on-accent: #ffffff;
                --text-disabled: #707070;
                --text-danger: #f17074;
                --drop-target: rgba(0, 149, 255, 0.15);
            }
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            background-color: var(--fill-color-layer-1);
            color: var(--text-primary);
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            font-weight: 400;
        }

        .transition-colors {
            transition: background-color 150ms ease, border-color 150ms ease, color 150ms ease;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 320px;
            min-width: 280px;
            background-color: var(--fill-color-layer-2);
            border-right: 1px solid var(--stroke-color-default);
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 16px;
        }

        .sidebar-header {
            display: flex;
            gap: 6px;
        }

        .search-input {
            flex-grow: 1;
            padding: 6px 10px;
            border-radius: var(--control-corner-radius);
            border: 1px solid var(--stroke-color-control);
            background-color: var(--fill-color-control);
            color: var(--text-primary);
        }

        .icon-btn {
            width: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .server-list-container {
            border: 1px solid var(--stroke-color-default);
            border-radius: var(--control-corner-radius);
            overflow-y: auto;
            flex-grow: 1;
            background-color: var(--fill-color-layer-3);
            display: flex;
            flex-direction: column;
        }

        /* --- Grouping Styles --- */
        .group-container {
            border-bottom: 1px solid var(--stroke-color-default);
        }

        .group-header {
            padding: 8px 10px;
            background-color: var(--fill-color-layer-2);
            font-weight: 600;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
        }

        .group-header:hover {
            background-color: var(--fill-color-control-hover);
        }

        .group-header .group-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .group-header .toggle-icon {
            font-size: 10px;
            transition: transform 0.2s;
        }

        .group-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .group-items {
            list-style: none;
            padding: 2px 0;
            margin: 0;
        }

        .group-header.collapsed + .group-items {
            display: none;
        }

        .server-list-item {
            padding: 6px 10px 6px 24px; /* Indent for hierarchy */
            cursor: default;
            user-select: none;
            border-left: 3px solid transparent;
        }

        .server-list-item:hover {
            background-color: var(--fill-color-list-hover);
        }

        .server-list-item.active {
            background-color: var(--fill-color-list-selected);
            color: var(--text-on-accent);
        }

        .server-list-item .server-name {
            font-weight: 600;
            display: block;
        }

        .server-list-item .server-info, .server-list-item .server-info-sub {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .server-list-item.active .server-info, .server-list-item.active .server-info-sub {
            color: var(--text-on-accent);
        }

        /* Drag and Drop Visuals */
        .server-list-item[draggable="true"], .group-header[draggable="true"] {
            cursor: grab;
        }

        .drag-over-group {
            background-color: var(--drop-target) !important;
            border-left: 3px solid var(--fill-color-accent);
        }

        .drag-over-item {
            border-top: 2px solid var(--fill-color-accent);
        }

        .content-header {
            padding-bottom: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--stroke-color-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 32px;
        }

        .content-title {
            font-size: 18px;
            font-weight: 600;
        }

        .content-actions .button {
            margin-left: 8px;
        }

        .content-card {
            background-color: var(--fill-color-layer-3);
            border: 1px solid var(--stroke-color-default);
            border-radius: var(--layer-corner-radius);
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .placeholder {
            display: flex;
            height: 100%;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-align: center;
        }

        fieldset {
            border: none;
            padding: 0;
            margin: 0 0 24px 0;
        }

        legend {
            font-size: 15px;
            font-weight: 600;
            padding: 0;
            margin-bottom: 16px;
            width: 100%;
            border-bottom: 1px solid var(--stroke-color-default);
            padding-bottom: 8px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px 16px;
            align-items: center;
        }

        .form-grid label {
            font-weight: 600;
            text-align: right;
        }

        .form-grid .full-width {
            grid-column: 2 / 3;
        }

        input[type="text"], input[type="password"], input[type="number"], select {
            width: 100%;
            padding: 6px 10px;
            border-radius: var(--control-corner-radius);
            border: 1px solid var(--stroke-color-control);
            background-color: var(--fill-color-control);
            color: var(--text-primary);
        }

        input:focus-visible, select:focus-visible {
            outline: none;
            border-color: var(--stroke-color-focus);
            box-shadow: 0 0 0 1px var(--stroke-color-focus) inset;
        }

        .form-view[data-mode="view"] input, .form-view[data-mode="view"] select {
            background-color: var(--fill-color-control-disabled);
            color: var(--text-disabled);
            border-color: transparent;
            padding-left: 10px;
            cursor: default;
            pointer-events: none;
        }

        .form-view[data-mode="view"] select {
            appearance: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .button {
            padding: 6px 16px;
            border: 1px solid var(--stroke-color-control);
            border-radius: var(--control-corner-radius);
            background-color: var(--fill-color-control);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .button:hover {
            background-color: var(--fill-color-control-hover);
        }

        .button.primary {
            background-color: var(--fill-color-accent);
            border-color: var(--fill-color-accent);
            color: var(--text-on-accent);
        }

        .button.primary:hover {
            background-color: var(--fill-color-accent-hover);
            border-color: var(--fill-color-accent-hover);
        }

        .button.danger {
            color: var(--text-danger);
        }

        .button.danger:hover {
            background-color: var(--text-danger);
            color: white;
            border-color: var(--text-danger);
        }

        .context-menu {
            position: absolute;
            z-index: 1000;
            display: none;
            list-style: none;
            padding: 6px;
            margin: 0;
            background-color: var(--fill-color-layer-3);
            border: 1px solid var(--stroke-color-default);
            border-radius: var(--layer-corner-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 160px;
        }

        .context-menu-item {
            padding: 6px 12px;
            cursor: default;
            border-radius: var(--control-corner-radius);
            user-select: none;
        }

        .context-menu-item:hover {
            background-color: var(--fill-color-list-hover);
        }

        .context-menu-item.danger:hover {
            background-color: var(--text-danger);
            color: white;
        }

        /* Port Forward Styles (Same as before) */
        .pf-list { display: flex; flex-direction: column; gap: 16px; }
        .pf-item { border: 1px solid var(--stroke-color-default); border-radius: var(--control-corner-radius); }
        .pf-item-header { display: flex; justify-content: space-between; align-items: center; padding: 8px; background-color: var(--fill-color-layer-2); border-bottom: 1px solid var(--stroke-color-default); }
        .pf-type-selector { display: flex; background-color: var(--fill-color-control); border: 1px solid var(--stroke-color-control); border-radius: var(--control-corner-radius); overflow: hidden; }
        .pf-type-selector button { background-color: transparent; border: none; padding: 4px 12px; cursor: pointer; border-left: 1px solid var(--stroke-color-control); color: var(--text-secondary); }
        .pf-type-selector button:first-child { border-left: none; }
        .pf-type-selector button.active { background-color: var(--fill-color-accent); color: var(--text-on-accent); }
        .pf-item-body { padding: 12px; }
        .pf-config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px 12px; align-items: center; }
        .pf-explanation { font-size: 12px; color: var(--text-secondary); margin-top: 10px; padding-top: 8px; border-top: 1px dashed var(--stroke-color-default); }
        .form-view[data-mode="view"] .pf-item { border-color: transparent; }
        .form-view[data-mode="view"] .pf-item-header { background-color: transparent; padding-left: 0; }
        .form-view[data-mode="view"] .pf-item-body { display: none; }
        .pf-view-summary { font-family: var(--font-monospace); font-size: 13px; color: var(--text-primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">
            <input type="text" id="search-input" class="search-input transition-colors" placeholder="筛选服务器...">
            <button id="add-group-btn" class="button icon-btn" title="新建分组">+</button>
        </div>
        <div class="server-list-container" id="server-list-container">
            <!-- Groups and Items rendered here -->
        </div>
        <button id="add-new-btn" class="button primary transition-colors" style="width: 100%;">新建连接</button>
    </div>
    <div class="main-content">
        <div class="content-header">
            <div id="content-title" class="content-title"></div>
            <div id="content-actions" class="content-actions"></div>
        </div>
        <div id="content-card" class="content-card">
            <div class="placeholder">请从左侧选择一个连接，或新建连接。</div>
        </div>
    </div>
</div>

<ul id="context-menu" class="context-menu">
    <!-- Dynamic Items -->
</ul>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const containerEl = document.getElementById('server-list-container');
        const searchInput = document.getElementById('search-input');
        const addGroupBtn = document.getElementById('add-group-btn');
        const addNewBtn = document.getElementById('add-new-btn');
        const contentCardEl = document.getElementById('content-card');
        const contentTitleEl = document.getElementById('content-title');
        const contentActionsEl = document.getElementById('content-actions');
        const contextMenuEl = document.getElementById('context-menu');

        let data = { servers: {}, groups: [] };
        let currentServerName = null;
        let currentMode = 'placeholder'; // 'placeholder', 'view', 'edit'
        let collapsedGroups = JSON.parse(localStorage.getItem('sshc_collapsed_groups') || '[]');

        // --- API Helpers ---
        async function api(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const err = await response.json().catch(() => ({error: '未知错误'}));
                    throw new Error(err.error || `HTTP ${response.status}`);
                }
                return options.method === 'DELETE' ? null : response.json();
            } catch (error) {
                alert(`操作失败: ${error.message}`);
                throw error;
            }
        }

        async function loadData() {
            try {
                data = await api('/api/config');
                renderSidebar();
                renderMainContent();
            } catch (error) {
                console.error(`加载失败: ${error.message}`);
            }
        }

        // --- Sidebar Rendering ---
        function renderSidebar() {
            containerEl.innerHTML = '';
            const filter = searchInput.value.toLowerCase();
            const groupedServers = {};
            const ungroupedServers = [];

            // Initialize defined groups buckets
            data.groups.forEach(g => groupedServers[g] = []);

            // Distribute servers
            Object.keys(data.servers).forEach(key => {
                const s = data.servers[key];
                // Apply Search Filter
                const searchMatch = key.toLowerCase().includes(filter) ||
                    (s.display_name || '').toLowerCase().includes(filter) ||
                    s.host.includes(filter);

                if (!searchMatch) return;

                if (s.group && data.groups.includes(s.group)) {
                    groupedServers[s.group].push({key, ...s});
                } else {
                    ungroupedServers.push({key, ...s});
                }
            });

            // Sort servers by display name within buckets
            const sortFn = (a, b) => (a.display_name || a.key).localeCompare(b.display_name || b.key, 'zh-CN');

            // Render Groups
            data.groups.forEach(groupName => {
                const servers = groupedServers[groupName].sort(sortFn);
                renderGroup(groupName, servers, false);
            });

            // Render Ungrouped
            ungroupedServers.sort(sortFn);
            renderGroup('未分组', ungroupedServers, true);
        }

        function renderGroup(name, servers, isUngrouped) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-container';
            // Ungrouped is technically a "null" group for drag logic
            groupDiv.dataset.groupName = isUngrouped ? '' : name;

            const isCollapsed = collapsedGroups.includes(name);

            const header = document.createElement('div');
            header.className = `group-header ${isCollapsed ? 'collapsed' : ''}`;
            if (!isUngrouped) {
                header.draggable = true;
                header.ondragstart = handleGroupDragStart;
                header.ondragover = handleGroupDragOver;
                header.ondrop = handleGroupDrop;
            }
            // All headers are drop targets for servers
            header.addEventListener('dragover', handleServerDragOver);
            header.addEventListener('dragleave', handleServerDragLeave);
            header.addEventListener('drop', handleServerDrop);

            // Context Menu for Header
            header.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY, isUngrouped ? 'ungrouped-header' : 'group-header', name);
            });

            header.onclick = (e) => {
                // Ignore clicks if they were dragged
                if (header.classList.contains('dragging')) return;
                toggleGroupCollapse(name);
            };

            header.innerHTML = `
                <span class="group-name">
                    <span class="toggle-icon">▼</span>
                    ${name} <span style="font-weight:normal; font-size:11px; margin-left:4px; opacity:0.7;">(${servers.length})</span>
                </span>
            `;
            groupDiv.appendChild(header);

            const ul = document.createElement('ul');
            ul.className = 'group-items';

            servers.forEach(s => {
                const li = document.createElement('li');
                li.className = `server-list-item transition-colors ${s.key === currentServerName ? 'active' : ''}`;
                li.draggable = true;
                li.dataset.name = s.key;
                li.ondragstart = handleServerDragStart;

                li.innerHTML = `
                    <span class="server-name">${s.display_name || s.key}</span>
                    <span class="server-info">(${s.key})</span>
                    <span class="server-info-sub">${s.user}@${s.host}</span>
                `;

                li.onclick = (e) => {
                    e.stopPropagation();
                    if (currentServerName !== s.key) {
                        currentServerName = s.key;
                        currentMode = 'view';
                        renderSidebar(); // refresh active state
                        renderMainContent();
                    }
                };

                li.oncontextmenu = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showContextMenu(e.clientX, e.clientY, 'server-item', s.key);
                };

                ul.appendChild(li);
            });

            groupDiv.appendChild(ul);
            containerEl.appendChild(groupDiv);
        }

        function toggleGroupCollapse(name) {
            const idx = collapsedGroups.indexOf(name);
            if (idx === -1) collapsedGroups.push(name);
            else collapsedGroups.splice(idx, 1);
            localStorage.setItem('sshc_collapsed_groups', JSON.stringify(collapsedGroups));
            renderSidebar();
        }

        // --- Drag and Drop Logic ---
        let dragSrcType = null; // 'group' or 'server'
        let dragSrcData = null;

        function handleGroupDragStart(e) {
            dragSrcType = 'group';
            dragSrcData = this.parentElement.dataset.groupName;
            e.dataTransfer.effectAllowed = 'move';
            this.classList.add('dragging');
        }

        function handleGroupDragOver(e) {
            if (dragSrcType !== 'group') return;
            e.preventDefault(); // Allow drop
            e.dataTransfer.dropEffect = 'move';
        }

        async function handleGroupDrop(e) {
            e.stopPropagation();
            if (dragSrcType !== 'group') return;
            const targetGroup = this.parentElement.dataset.groupName;

            if (dragSrcData !== targetGroup) {
                // Reorder Groups
                const oldIdx = data.groups.indexOf(dragSrcData);
                const newIdx = data.groups.indexOf(targetGroup);
                if (oldIdx > -1 && newIdx > -1) {
                    data.groups.splice(oldIdx, 1);
                    data.groups.splice(newIdx, 0, dragSrcData);
                    await saveGroups(data.groups);
                }
            }
        }

        function handleServerDragStart(e) {
            e.stopPropagation();
            dragSrcType = 'server';
            dragSrcData = this.dataset.name;
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleServerDragOver(e) {
            if (dragSrcType !== 'server') return;
            e.preventDefault();
            this.classList.add('drag-over-group');
        }

        function handleServerDragLeave(e) {
            this.classList.remove('drag-over-group');
        }

        async function handleServerDrop(e) {
            if (dragSrcType !== 'server') return;
            e.preventDefault();
            this.classList.remove('drag-over-group');

            // "Ungrouped" logic is stored as empty string in data attributes
            const targetGroupName = this.parentElement.dataset.groupName || '';
            const serverName = dragSrcData;

            if (data.servers[serverName] && data.servers[serverName].group !== targetGroupName) {
                // Only update if changed (Ungrouped vs null check needed?)
                const currentGroup = data.servers[serverName].group || '';
                if (currentGroup !== targetGroupName) {
                    // Update server group
                    const server = data.servers[serverName];
                    server.group = targetGroupName === '' ? null : targetGroupName;

                    // Save to backend
                    try {
                        await api('/api/server', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                name: serverName,
                                original_name: serverName, // no rename
                                ...server
                            })
                        });
                        loadData(); // Reload to refresh view
                    } catch (err) {
                        console.error(err);
                    }
                }
            }
        }

        // --- Group Management API ---
        async function saveGroups(newGroups) {
            try {
                await api('/api/groups', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ groups: newGroups })
                });
                loadData();
            } catch (err) {
                console.error(err);
            }
        }

        async function createGroup() {
            const name = prompt("请输入新分组名称:");
            if (name) {
                if (data.groups.includes(name)) return alert("分组已存在");
                data.groups.push(name);
                await saveGroups(data.groups);
            }
        }

        async function renameGroup(oldName) {
            const newName = prompt("请输入新分组名称:", oldName);
            if (newName && newName !== oldName) {
                if (data.groups.includes(newName)) return alert("分组已存在");

                // Client-side optimistic update logic for simplicity,
                // but really should iterate servers.
                // Step 1: Update Group List
                const idx = data.groups.indexOf(oldName);
                if (idx !== -1) data.groups[idx] = newName;
                await saveGroups(data.groups);

                // Step 2: Update Servers
                // This is suboptimal (many requests), but works for now without bulk API
                const promises = [];
                for (const [key, server] of Object.entries(data.servers)) {
                    if (server.group === oldName) {
                        server.group = newName;
                        promises.push(api('/api/server', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ name: key, original_name: key, ...server })
                        }));
                    }
                }
                await Promise.all(promises);
                loadData();
            }
        }

        async function deleteGroup(name) {
            if (confirm(`删除分组 "${name}"? 组内服务器将变为未分组。`)) {
                // Step 1: Remove from group list
                const idx = data.groups.indexOf(name);
                if (idx > -1) {
                    data.groups.splice(idx, 1);
                    await saveGroups(data.groups);
                }

                // Step 2: Update Servers
                const promises = [];
                for (const [key, server] of Object.entries(data.servers)) {
                    if (server.group === name) {
                        server.group = null;
                        promises.push(api('/api/server', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ name: key, original_name: key, ...server })
                        }));
                    }
                }
                await Promise.all(promises);
                loadData();
            }
        }


        // --- Context Menu ---
        function showContextMenu(x, y, type, target) {
            contextMenuEl.innerHTML = '';
            contextMenuEl.dataset.target = target;
            contextMenuEl.dataset.type = type;

            const items = [];

            if (type === 'server-item') {
                items.push({ text: '复制连接命令', action: 'copy' });
                items.push({ text: '删除连接', action: 'delete-server', danger: true });
            } else if (type === 'group-header') {
                items.push({ text: '重命名分组', action: 'rename-group' });
                items.push({ text: '删除分组', action: 'delete-group', danger: true });
            } else if (type === 'ungrouped-header') {
                // Nothing special for ungrouped header yet
                return;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = `context-menu-item ${item.danger ? 'danger' : ''}`;
                li.textContent = item.text;
                li.onclick = () => handleContextAction(item.action, target);
                contextMenuEl.appendChild(li);
            });

            contextMenuEl.style.top = `${y}px`;
            contextMenuEl.style.left = `${x}px`;
            contextMenuEl.style.display = 'block';
        }

        async function handleContextAction(action, target) {
            contextMenuEl.style.display = 'none';
            if (action === 'delete-server') {
                if (confirm(`确认删除连接 "${target}"?`)) {
                    await api(`/api/server/${target}`, {method: 'DELETE'});
                    if (currentServerName === target) {
                        currentServerName = null;
                        currentMode = 'placeholder';
                    }
                    loadData();
                }
            } else if (action === 'copy') {
                navigator.clipboard.writeText(`sshc "${target}"`);
            } else if (action === 'rename-group') {
                renameGroup(target);
            } else if (action === 'delete-group') {
                deleteGroup(target);
            }
        }

        document.addEventListener('click', () => {
            contextMenuEl.style.display = 'none';
        });

        // --- Main Content & Form (Similar to previous, updated for Groups) ---
        function renderMainContent() {
            let title = '', actionsHTML = '', contentHTML = '';
            const isNew = currentMode === 'edit' && !data.servers[currentServerName];

            if (currentMode === 'edit') {
                title = isNew ? '新建连接' : `编辑: ${currentServerName}`;
                actionsHTML = `<button id="save-btn" class="button primary transition-colors">保存</button><button id="cancel-btn" class="button transition-colors">取消</button>`;
            } else if (currentMode === 'view') {
                title = `查看: ${currentServerName}`;
                actionsHTML = `<button id="edit-btn" class="button primary transition-colors">编辑</button><button id="delete-btn" class="button danger transition-colors">删除</button>`;
            } else {
                title = 'SSH 连接管理器';
            }

            if (currentMode === 'view' || currentMode === 'edit') {
                contentHTML = createFormHTML(currentServerName, data.servers[currentServerName] || {}, currentMode);
            } else {
                contentHTML = `<div class="placeholder">请从左侧选择一个连接，或新建连接。</div>`;
            }

            contentTitleEl.textContent = title;
            contentActionsEl.innerHTML = actionsHTML;
            contentCardEl.innerHTML = contentHTML;
        }

        function createFormHTML(name, server, mode) {
            const isNew = !data.servers[name];
            const isViewMode = mode === 'view';
            const pf = server.port_forwards || [];

            // Group Options
            let groupOptions = `<option value="">(未分组)</option>`;
            data.groups.forEach(g => {
                const selected = (server.group === g) ? 'selected' : '';
                groupOptions += `<option value="${g}" ${selected}>${g}</option>`;
            });

            return `
                <div class="form-view" data-mode="${mode}">
                    <form id="server-form">
                        <fieldset>
                            <legend>基本信息</legend>
                            <div class="form-grid">
                                <label for="display_name">显示名称</label> <input type="text" id="display_name" value="${server.display_name || ''}" ${isViewMode ? 'readonly' : ''}>
                                <label for="group">分组</label>
                                <select id="group" ${isViewMode ? 'disabled' : ''}>${groupOptions}</select>
                                <label for="name">连接名称</label> <input type="text" id="name" value="${isNew ? '' : name}" required ${isViewMode || !isNew ? 'readonly' : ''}>
                                <label for="host">主机</label> <input type="text" id="host" value="${server.host || ''}" required ${isViewMode ? 'readonly' : ''}>
                                <label for="port">端口</label> <input type="number" id="port" value="${server.port || ''}" placeholder="22" ${isViewMode ? 'readonly' : ''}>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>身份验证</legend>
                            <div class="form-grid">
                                <label for="user">用户名</label> <input type="text" id="user" value="${server.user || ''}" required ${isViewMode ? 'readonly' : ''}>
                                <label for="password">密码</label> <input type="password" id="password" value="${server.password || ''}" placeholder="留空则不使用" ${isViewMode ? 'readonly' : ''}>
                                <label></label> <div class="full-width checkbox-group"><input type="checkbox" id="store-plaintext" ${(!server.is_password_encrypted && server.password) ? 'checked' : ''} ${isViewMode ? 'disabled' : ''}><label for="store-plaintext">明文存储密码</label></div>
                                <label for="keyfile">私钥文件</label> <input type="text" id="keyfile" value="${server.keyfile || ''}" placeholder="~/.ssh/id_rsa" ${isViewMode ? 'readonly' : ''}>
                            </div>
                        </fieldset>
                        <fieldset>
                             <legend>高级 / 端口转发</legend>
                             <div class="form-grid">
                               <label></label>
                               <div class="full-width checkbox-group">
                                   <input type="checkbox" id="x11-forwarding" ${server.x11_forwarding ? 'checked' : ''} ${isViewMode ? 'disabled' : ''}><label for="x11-forwarding">X11 转发</label>
                               </div>
                               <label for="ssh_prefix_command">前缀命令</label>
                               <input type="text" id="ssh_prefix_command" value="${server.ssh_prefix_command || ''}" ${isViewMode ? 'readonly' : ''}>

                               <label>规则</label>
                               <div class="full-width">
                                   <div id="pf-list" class="pf-list">${pf.map((r, i) => createPFItem(r, i, mode)).join('')}</div>
                                   ${mode === 'edit' ? '<button type="button" id="add-pf-btn" class="button" style="margin-top:12px">添加转发规则</button>' : ''}
                               </div>
                             </div>
                        </fieldset>
                    </form>
                </div>
            `;
        }

        // --- Helper for Port Forwards (Simplified from previous) ---
        function createPFItem(pf, index, mode) {
            if (mode === 'view') {
                let s = '';
                if(pf.type==='local') s=`Local: ${pf.local_port||0} -> ${pf.remote_host}:${pf.remote_port||0}`;
                else if(pf.type==='remote') s=`Remote: ${pf.remote_port||0} -> ${pf.local_host}:${pf.local_port||0}`;
                else s=`Dynamic: ${pf.local_port||0}`;
                return `<div class="pf-item"><div class="pf-item-header"><span class="pf-view-summary">${s}</span></div></div>`;
            }
            // Edit Mode HTML ... (omitted for brevity, assume similar structure to previous but with updated field access logic)
            // Reusing the structure from previous code for Edit mode logic
            const types = {local: '本地', remote: '远程', dynamic: '动态'};
            return `
                <div class="pf-item">
                    <div class="pf-item-header">
                        <div class="pf-type-selector">${Object.keys(types).map(t => `<button type="button" data-type="${t}" class="${pf.type === t ? 'active' : ''}">${types[t]}</button>`).join('')}</div>
                        <button type="button" class="button danger" data-action="del-pf">删除</button>
                    </div>
                    <div class="pf-item-body">
                         <div class="pf-config-grid">
                            ${pf.type === 'local' ? `<div><label>本地</label><input type="number" data-key="local_port" value="${pf.local_port || ''}"></div><div><label>远程主机</label><input type="text" data-key="remote_host" value="${pf.remote_host || 'localhost'}"></div><div><label>远程端口</label><input type="number" data-key="remote_port" value="${pf.remote_port || ''}"></div>` : ''}
                            ${pf.type === 'remote' ? `<div><label>远程</label><input type="number" data-key="remote_port" value="${pf.remote_port || ''}"></div><div><label>本地主机</label><input type="text" data-key="local_host" value="${pf.local_host || 'localhost'}"></div><div><label>本地端口</label><input type="number" data-key="local_port" value="${pf.local_port || ''}"></div>` : ''}
                            ${pf.type === 'dynamic' ? `<div><label>SOCKS端口</label><input type="number" data-key="local_port" value="${pf.local_port || ''}"></div>` : ''}
                        </div>
                    </div>
                </div>`;
        }

        // --- Form Interaction ---
        contentCardEl.addEventListener('click', (e) => {
            if (e.target.id === 'add-pf-btn') {
                document.getElementById('pf-list').insertAdjacentHTML('beforeend', createPFItem({type: 'local'}, 0, 'edit'));
            } else if (e.target.dataset.action === 'del-pf') {
                e.target.closest('.pf-item').remove();
            } else if (e.target.parentElement.classList.contains('pf-type-selector') && e.target.tagName === 'BUTTON') {
                // Switch Type
                const item = e.target.closest('.pf-item');
                item.outerHTML = createPFItem({type: e.target.dataset.type}, 0, 'edit');
            }
        });

        contentActionsEl.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;
            if(btn.id === 'edit-btn') {
                currentMode = 'edit'; renderMainContent();
            } else if (btn.id === 'cancel-btn') {
                currentMode = data.servers[currentServerName] ? 'view' : 'placeholder';
                if(currentMode==='placeholder') currentServerName = null;
                renderMainContent(); renderSidebar();
            } else if (btn.id === 'save-btn') {
                await saveForm();
            } else if (btn.id === 'delete-btn') {
                if (confirm(`删除 ${currentServerName}?`)) {
                    await api(`/api/server/${currentServerName}`, {method: 'DELETE'});
                    currentServerName = null; currentMode = 'placeholder';
                    loadData();
                }
            }
        });

        async function saveForm() {
            const form = document.getElementById('server-form');
            const newName = form.querySelector('#name').value.trim();
            if(!newName) return alert("名称必填");

            const payload = {
                name: newName,
                original_name: currentServerName === newName ? null : (data.servers[currentServerName] ? currentServerName : null),
                display_name: form.querySelector('#display_name').value.trim(),
                group: form.querySelector('#group').value || null,
                host: form.querySelector('#host').value.trim(),
                user: form.querySelector('#user').value.trim(),
                port: form.querySelector('#port').value,
                keyfile: form.querySelector('#keyfile').value.trim(),
                password: form.querySelector('#password').value,
                x11_forwarding: form.querySelector('#x11-forwarding').checked,
                ssh_prefix_command: form.querySelector('#ssh_prefix_command').value.trim(),
                store_password_as_plaintext: form.querySelector('#store-plaintext').checked,
                port_forwards: Array.from(document.querySelectorAll('.pf-item')).map(item => {
                    const type = item.querySelector('.pf-type-selector .active').dataset.type;
                    const rule = {type};
                    item.querySelectorAll('input[data-key]').forEach(i => rule[i.dataset.key] = i.value);
                    return rule;
                })
            };

            await api('/api/server', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            currentServerName = newName;
            currentMode = 'view';
            loadData();
        }

        // --- Init ---
        addGroupBtn.onclick = createGroup;
        addNewBtn.onclick = () => {
            currentServerName = `new-server-${Date.now()}`;
            currentMode = 'edit';
            renderSidebar(); // clear selection visual
            renderMainContent();
        };
        searchInput.oninput = renderSidebar;

        loadData();
    });
</script>

</body>
</html>